<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Checkout</title>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<h2>Checkout</h2>

<input placeholder="Full Name">
<input placeholder="Address">
<input placeholder="City">
<input placeholder="Phone">
<br><br>

<div id="summaryItems"></div>
<h3 id="total"></h3>

<button onclick="placeOrder()">Pay Now</button>

<script>

const CHECKOUT_API=
"http://localhost:8082/checkout";

function loadSummary(){
    let cart=JSON.parse(localStorage.getItem("cart"))||[];
    let total=0;
    let html="";

    cart.forEach(item=>{
        total+=item.price*item.qty;
        html+=`${item.name} x ${item.qty}<br>`;
    });

    document.getElementById("summaryItems").innerHTML=html;
    document.getElementById("total").innerText="Total: â‚¹"+total;
}

async function placeOrder(){

    let cart=JSON.parse(localStorage.getItem("cart"))||[];

    const fullName=document.querySelectorAll("input")[0].value;
    const addressLine1=document.querySelectorAll("input")[1].value;
    const city=document.querySelectorAll("input")[2].value;
    const phone=document.querySelectorAll("input")[3].value;

    const requestBody={
        userId:1,
        paymentMethod:"RAZORPAY",
        items:cart.map(item=>({
            productId:item.productId,
            quantity:item.qty
        })),
        address:{
            fullName,
            phone,
            addressLine1,
            city,
            state:"Delhi",
            pincode:"110001"
        }
    };

    const response=await fetch(CHECKOUT_API,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(requestBody)
    });

    if(!response.ok){
        const error=await response.text();
        alert(error);
        return;
    }

    const razorpayOrderId=await response.text();

    const options={
        key:"rzp_test_SElR6dCtE9ARWL",
        order_id:razorpayOrderId,
        name:"My Store",
        description:"Order Payment",
        handler:function(){
            alert("Payment Successful!");
            localStorage.removeItem("cart");
            window.location.href="index.html";
        }
    };

    const rzp=new Razorpay(options);
    rzp.open();
}

loadSummary();

</script>

</body>
</html>
